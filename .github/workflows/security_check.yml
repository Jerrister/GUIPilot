name: Security Check

on:
  # 触发时机: 和代码风格检查保持一致，也可单独配置
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 可选: 每周一自动执行一次全量安全检查 (定期扫描依赖漏洞) 
  schedule:
    - cron: '0 0 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 缓存 Conda 环境 (复用代码风格检查的缓存逻辑) 
        uses: actions/cache@v3
        with:
          path: |
            ~/miniconda3/envs/guipilot
            ~/miniconda3/pkgs
            ~/.cache/pip
          key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
          restore-keys: |
            ${{ runner.os }}-conda-

      - name: 配置 Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: environment.yml
          activate-environment: guipilot
          miniconda-version: "latest"

      - name: 安装安全检查工具
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          # 1. bandit: 检查代码中的安全漏洞 (如 SQL 注入、硬编码密钥等) 
          # 2. safety: 检查依赖中的已知安全漏洞
          pip install bandit

      # 步骤1: bandit 代码安全漏洞检查
      - name: Bandit - 代码安全漏洞扫描
        shell: bash -l {0}
        run: |
          echo "===== 开始 Bandit 代码安全检查 ====="
          # -r: 递归扫描目录
          bandit -r guipilot/ experiments/ --tests B105,B108,B311,B603
          echo "===== Bandit 检查结束 ====="
          echo ""