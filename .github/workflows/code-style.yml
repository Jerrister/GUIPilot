name: Code Style Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  style-check:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
      
      - name: 缓存 Conda 环境（减少依赖安装时间）
        uses: actions/cache@v3
        with:
          # 缓存 Conda 环境和包缓存目录
          path: |
            ~/miniconda3/envs/guipilot
            ~/miniconda3/pkgs
            ~/.cache/pip  # 缓存 pip 安装的工具
          # 缓存键：系统 + Conda 环境文件哈希（环境文件不变则复用缓存）
          key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}
          # 回退键：匹配相同系统的旧缓存（加速首次缓存命中）
          restore-keys: |
            ${{ runner.os }}-conda-

      - name: 配置 Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: environment.yml
          activate-environment: guipilot
          miniconda-version: "latest"

      - name: 安装代码检查工具
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 pylint

      # 1. Black 格式检查（不中断，输出需格式化文件数）
      - name: Black 代码格式检查
        shell: bash -l {0}
        run: |
          echo "===== 开始 Black 检查 ====="
          black --check guipilot/ experiments/
          echo "===== Black 检查结束 ====="
          echo ""

      # 2. Flake8 致命错误检查（不中断，输出错误数）
      - name: Flake8 语法错误检查
        shell: bash -l {0}
        run: |
          echo "===== 开始 Flake8 检查 ====="
          flake8 guipilot/ experiments/ --select=E9,F63,F7,F82 --statistics
          echo "===== Flake8 检查结束 ====="
          echo ""

      # 3. Pylint 代码质量检查（不中断，输出 Error/Warning 数和评分）
      - name: Pylint 代码质量检查
        shell: bash -l {0}
        run: |
          echo "===== 开始 Pylint 检查 ====="
          pylint guipilot/ experiments/ --disable=E0401,E1101,R0912,R0913,R0914,R0915,R0917 || true
          echo "===== Pylint 检查结束 ====="